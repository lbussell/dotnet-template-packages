name: Publish NuGet Package
on:
  workflow_dispatch:
    inputs:
      stable-version:
        description: 'Publish as a stable version (no prerelease suffix)'
        type: boolean
        required: true
        default: false

# Deny all permissions by default
permissions: {}

jobs:
  build:
    uses: ./.github/workflows/build.yml
    with:
      stable-version: ${{ inputs.stable-version }}
    permissions:
      contents: read

  publish:
    needs: build
    runs-on: ubuntu-latest
    environment: production
    permissions:
      packages: write
      # Required to issue OIDC token for NuGet trusted publishing
      id-token: write
    steps:
      # https://github.com/actions/setup-dotnet/releases/tag/v5.0.1
      - uses: actions/setup-dotnet@2016bd2012dba4e32de620c46fe006a3ac9f0602
        with:
          dotnet-version: 10.0.x

      # Download the NuGet packages built in the build job
      # https://github.com/actions/download-artifact/releases/tag/v4.2.1
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e
        with:
          name: nuget-packages
          path: packages

      - name: List packages to publish
        run: ls -la packages/*.nupkg

      # Use the ambient GitHub token to login to NuGet and retrieve an API key
      # https://github.com/NuGet/login/releases/tag/v1
      - name: NuGet login
        uses: NuGet/login@d22cc5f58ff5b88bf9bd452535b4335137e24544
        id: nuget-login
        with:
          user: ${{ secrets.NUGET_USER }}

      - name: Publish to NuGet.org
        run: >-
          dotnet nuget push "packages/*.nupkg"
          --api-key "${{ steps.nuget-login.outputs.NUGET_API_KEY }}"
          --source https://api.nuget.org/v3/index.json
